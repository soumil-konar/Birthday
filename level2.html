<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Level 02: Fragments</title>
    <style>
        :root {
            --primary-color: #ff6b81;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-color: #ffffff;
        }

        body {
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-gradient);
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
            color: white;
        }

        h2 { margin-bottom: 10px; font-weight: 300; letter-spacing: 2px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        p { margin-bottom: 20px; opacity: 0.8; font-size: 0.9rem; }

        /* --- The Puzzle Container --- */
        .puzzle-container {
            width: 300px;
            height: 300px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 2px;
            padding: 10px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            position: relative;
        }

        /* --- Individual Pieces --- */
        .piece {
            width: 100%;
            height: 100%;
            background-image: url('https://images.unsplash.com/photo-1518895949257-7621c3c786d7?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80'); /* PLACEHOLDER IMAGE */
            background-size: 300px 300px; /* Must match container size */
            cursor: pointer;
            border-radius: 5px;
            transition: transform 0.2s, box-shadow 0.2s;
            box-sizing: border-box;
        }

        .piece:hover {
            transform: scale(0.95);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            z-index: 10;
        }

        .selected {
            border: 2px solid #ff6b81;
            transform: scale(0.9);
            box-shadow: 0 0 15px #ff6b81;
        }

        /* --- Success Overlay --- */
        .overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
            z-index: 100;
        }

        .message-card {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
            max-width: 80%;
            transform: translateY(20px);
            transition: transform 0.5s ease;
        }

        .overlay.active { opacity: 1; pointer-events: all; }
        .overlay.active .message-card { transform: translateY(0); }

        .btn {
            margin-top: 15px;
            padding: 10px 25px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
        }

    </style>
</head>
<body>

    <h2>LEVEL 02</h2>
    <p>Tap two pieces to swap them until the memory is clear.</p>

    <div class="puzzle-container" id="board">
        </div>

    <div class="overlay" id="successOverlay">
        <div class="message-card">
            <h3 style="color: #ff6b81; margin-bottom: 10px;">Memory Restored! ❤️</h3>
            <p>I remember this day exactly. You looked beautiful.</p>
            <hr style="border: 0; border-top: 1px solid #ddd; margin: 15px 0;">
            <p style="font-size: 0.9rem; color: #555;">The password for the next level is:</p>
            <h2 style="letter-spacing: 5px; margin: 10px 0;">SONG22</h2>
            <button class="btn" onclick="window.location.href='level3.html'">Go to Level 3</button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // 1. Image URL: Replace the Unsplash link below with your girlfriend's photo path.
        // Tip: Use a square image for best results, or it will be squashed.
        const imageUrl = 'https://images.unsplash.com/photo-1518895949257-7621c3c786d7?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80';
        
        // 2. Grid Size (3x3 is standard)
        const size = 3; 
        
        // --- LOGIC ---
        const board = document.getElementById('board');
        let pieces = [];
        let selectedPiece = null;

        // Calculate positions
        // We create an array of objects representing the correct order: [{x:0, y:0}, {x:1, y:0}...]
        let correctOrder = [];
        for (let y = 0; y < size; y++) {
            for (let x = 0; x < size; x++) {
                correctOrder.push({ x, y });
            }
        }

        // Initialize Game
        function initGame() {
            // Create a shuffled version of the order
            let shuffled = [...correctOrder];
            
            // Simple shuffle algorithm
            // We ensure it's not accidentally solved already
            do {
                shuffled.sort(() => Math.random() - 0.5);
            } while (isSolved(shuffled));

            renderBoard(shuffled);
        }

        function renderBoard(currentOrder) {
            board.innerHTML = ''; // Clear board
            pieces = [];

            currentOrder.forEach((pos, index) => {
                const piece = document.createElement('div');
                piece.classList.add('piece');
                
                // CSS Trick: Shift background image to show only the slice for this piece's LOGICAL position
                // The 'pos' object tells us WHICH part of the image this tile should show
                piece.style.backgroundImage = `url('${imageUrl}')`;
                piece.style.backgroundPosition = `-${pos.x * 100}px -${pos.y * 100}px`;
                
                // Store current data for logic
                piece.dataset.currentX = pos.x;
                piece.dataset.currentY = pos.y;
                piece.dataset.index = index; // Current visual slot (0-8)

                piece.addEventListener('click', () => handlePieceClick(piece, index));
                
                board.appendChild(piece);
                pieces.push(piece);
            });
        }

        function handlePieceClick(clickedPiece, index) {
            if (selectedPiece === null) {
                // Select first piece
                selectedPiece = clickedPiece;
                clickedPiece.classList.add('selected');
            } else {
                // Select second piece and swap
                if (selectedPiece !== clickedPiece) {
                    swapPieces(selectedPiece, clickedPiece);
                }
                // Deselect
                selectedPiece.classList.remove('selected');
                selectedPiece = null;
            }
        }

        function swapPieces(pieceA, pieceB) {
            // Swap DOM elements visually? No, easier to just swap background positions and data
            // Actually, for the logic to hold, we need to swap the DATA in the array representation
            // But visually swapping style.backgroundPosition is the easiest "cheat" way to do it
            
            const tempBg = pieceA.style.backgroundPosition;
            const tempDataX = pieceA.dataset.currentX;
            const tempDataY = pieceA.dataset.currentY;

            pieceA.style.backgroundPosition = pieceB.style.backgroundPosition;
            pieceA.dataset.currentX = pieceB.dataset.currentX;
            pieceA.dataset.currentY = pieceB.dataset.currentY;

            pieceB.style.backgroundPosition = tempBg;
            pieceB.dataset.currentX = tempDataX;
            pieceB.dataset.currentY = tempDataY;

            checkWin();
        }

        function checkWin() {
            // Check if every piece is in its correct original slot
            // Slot 0 should have x=0, y=0. Slot 1 should have x=1, y=0, etc.
            
            let isWin = true;
            const allPieces = document.querySelectorAll('.piece');

            allPieces.forEach((p, index) => {
                const correctX = index % size;
                const correctY = Math.floor(index / size);
                
                if (parseInt(p.dataset.currentX) !== correctX || parseInt(p.dataset.currentY) !== correctY) {
                    isWin = false;
                }
            });

            if (isWin) {
                setTimeout(() => {
                    document.getElementById('successOverlay').classList.add('active');
                }, 300);
            }
        }

        // Helper to ensure we don't start with a solved puzzle
        function isSolved(arr) {
            return arr.every((pos, i) => pos.x === i % size && pos.y === Math.floor(i / size));
        }

        // Start
        initGame();

    </script>
</body>
</html>